name: CI

on:
  workflow_call:
  pull_request:
  push:

defaults:
  run:
    shell: bash

env:
  RELEASE: ${{ github.event_name == 'push' && contains(github.ref, 'refs/tags/test-v') }}
  # The test-installer job can use an old existing image rather than the most
  # recently built image; the 'needs' can be commented out to allow the
  # test-installer job to run independently (and therefore faster)
  INSTALLER_USE_OLD_IMAGE: false
  INSTALLER_OLD_RUNID: 3204825457
  # The test-installer job can run with the pyinstaller debug bundle
  INSTALLER_USE_DEBUG: false
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:

  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: astral-sh/ruff-action@v3
        with:
          version: "latest"
          args: "check --fix-only --exit-non-zero-on-fix"
      - uses: pre-commit-ci/lite-action@v1.1.0
        if: always()
        with:
          msg: '[pre-commit.ci lite] apply automatic fixes for ruff linting errors'

  matrix:
    needs: [ruff]
    name: Generate test matrix

    #if: false    # uncomment to prevent the rest of the workflow running

    runs-on: ubuntu-latest

    # Stop existing workflows for matching branches and pull requests
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true

    outputs:
      test-matrix-json: ${{ steps.set-matrix.outputs.test_matrix }}
      installer-matrix-json: ${{ steps.set-matrix.outputs.installer_matrix }}

    steps:
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12

      - uses: actions/checkout@v5

      - name: Generate job configuration matrix
        id: set-matrix
        run: python .github/workflows/matrix.py >> $GITHUB_OUTPUT


  build-dependencies:
    needs: [ruff]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        dependency:
          # the ref can be a branch or a tag
          - { name: "sasdata", url: "https://github.com/SasView/sasdata.git", ref: "master" }
          - { name: "sasmodels",  url: "https://github.com/SasView/sasmodels.git", ref: "master" }
          # - { name: "bumps", url: "https://github.com/bumps/bumps.git", ref: "v1.0.3" }

    name: Build wheel ${{ matrix.dependency.name }}

    steps:
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12

      ### Check if this wheel is already cached

      - name: Get latest commit SHA for ${{ matrix.dependency.name }}
        id: get-sha
        run: |
          REF="${{ matrix.dependency.ref }}"
          URL="${{ matrix.dependency.url }}"

          # Try as branch first, then as tag
          SHA=$(git ls-remote "$URL" "refs/heads/$REF" | cut -f1)
          if [ -z "$SHA" ]; then
            SHA=$(git ls-remote "$URL" "refs/tags/$REF" | cut -f1)
          fi

          echo "Using $REF ($SHA)"
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Obtain wheel cache
        id: cache-wheel
        uses: actions/cache@v4
        with:
          path: ~/.cache/cache-wheel/
          key: wheel-${{ matrix.dependency.name }}-${{ steps.get-sha.outputs.sha }}

      ### Build the wheel for the build-dependency


      - name: Install build tools (cache miss)
        if: steps.cache-wheel.outputs.cache-hit != 'true'
        run: |
          python -m pip install build

      - name: Build wheel for ${{ matrix.dependency.name }} (cache miss)
        if: steps.cache-wheel.outputs.cache-hit != 'true'
        run: |
          git clone --branch ${{ matrix.dependency.ref }} ${{ matrix.dependency.url }} ${{ matrix.dependency.name }}
          cd ${{ matrix.dependency.name }}
          python -m build --wheel
          mkdir -p  ~/.cache/cache-wheel/
          cp dist/*whl ~/.cache/cache-wheel/

      - name: Store wheel of ${{ matrix.dependency.name }} for use
        uses: actions/upload-artifact@v4
        with:
          name: build-dependency-${{ matrix.dependency.name }}-wheel
          path: |
           ~/.cache/cache-wheel/*.whl
          if-no-files-found: error

  build-sasview:
    needs: [build-dependencies]

    name: Build wheel sasview

    env:
      UV_SYSTEM_PYTHON: 1

    runs-on: ubuntu-latest

    steps:
      - name: Obtain SasView source from git
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.12

      - name: Install uv utilities to speed up python module installation
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          prune-cache: false

      ### Installation of build-dependencies

      - name: Install system library build-dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo eatmydata apt-get update
          # libcairo2-dev is for building a wheel for pycairo if not cached
          # rest are for loading Qt widgets
          sudo eatmydata apt-get -y install libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 x11-utils xvfb libegl-dev libcairo2-dev

      - name: Fetch wheels of sibling projects
        uses: actions/download-artifact@v5
        with:
          path: dist/
          pattern: build-dependency-*-wheel
          merge-multiple: true

      - name: Install correct versions of sibling projects
        run: |
          uv pip install dist/*whl

      - name: Install Python dependencies
        run: |
          uv pip install -r build_tools/requirements-dev.txt

      ### Actual building of sasview

      - name: Build sasview
        run: |
          python -m build --no-isolation --sdist --wheel

      - name: Publish sdist
        uses: actions/upload-artifact@v4
        with:
          name: sasview-sdist
          path: |
            dist/sasview*tar*
          if-no-files-found: error

      - name: Publish wheel package
        uses: actions/upload-artifact@v4
        with:
          name: sasview-wheel
          path: |
            dist/sasview*whl
          if-no-files-found: error

  test-matrix:
    needs: [matrix, build-sasview]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.test-matrix-json) }}
    env:
      RELEASE_BRANCH_BUILD: ${{
          (
            (github.event_name == 'push' && contains(github.ref, 'release')) ||
            (github.event_name == 'push' && contains(github.ref, 'tags/v6.1')) ||
            (github.event_name == 'pull_request' && contains(github.base_ref, 'release-6.1'))
          ) && 'true' || '' }}
      UV_SYSTEM_PYTHON: 1

    name: "${{ matrix.job_name }}"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Obtain SasView source from git
        uses: actions/checkout@v5

      - name: Install sasview wheel (and dependencies)
        uses: ./.github/actions/install-wheel
        with:
          python-version: ${{ matrix.python-version }}
          os: ${{ matrix.os }}

      ### Run tests

      - name: Install test dependencies
        run: |
          uv pip install -r build_tools/requirements-test.txt

      - name: Test with pytest
        if: ${{ matrix.tests }}
        env:
          PYOPENCL_COMPILER_OUTPUT: 1
        run: |
          # run the tests against the installed package
          cp -r test pyproject.toml conftest.py $RUNNER_TEMP
          cd $RUNNER_TEMP
          python -m pytest -v -s test

      # - name: Test GUI (Linux)
      #   if: ${{ matrix.os == 'ubuntu-latest' }}
      #   env:
      #     PYOPENCL_COMPILER_OUTPUT: 1
      #   run: |
      #     # Suppress SIGSEGV from the tests until they can be fixed
      #     retval=0
      #     xvfb-run -a --server-args="-screen 0 1600x900x24" python -m pytest -rsx -v src/sas/qtgui/ || retval=$?
      #     if [ $retval -eq 139 ]; then echo "WARNING: Python interpreter exited with Segmentation Fault. This normally indicates that Qt objects were not correctly deleted. This error is currently suppressed in SasView's test suite."; retval=0; fi
      #     exit $retval

  installer-matrix:
    needs: [matrix, build-sasview]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.installer-matrix-json) }}
    env:
      MACOS_DMG_NAME: SasView6-${{ matrix.os }}.dmg
      # Be strict about version pinning during the release freeze
      RELEASE_BRANCH_BUILD: ${{
          (
            (github.event_name == 'push' && contains(github.ref, 'release')) ||
            (github.event_name == 'push' && contains(github.ref, 'tags/v6.1')) ||
            (github.event_name == 'pull_request' && contains(github.base_ref, 'release-6.1'))
          ) && 'true' || '' }}

      # Only sign the installer if non-forked repo
      SIGN_INSTALLER: ${{ (! github.event.repository.fork && ! github.event.pull_request.head.repo.fork ) && 'true' || '' }}

      UV_SYSTEM_PYTHON: 1

    name: "${{ matrix.job_name }}"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Obtain SasView source from git
        uses: actions/checkout@v5

      - name: Install sasview wheel (and dependencies)
        uses: ./.github/actions/install-wheel
        with:
          python-version: ${{ matrix.python-version }}
          os: ${{ matrix.os }}

      ### Build the installer

      - name: Install utilities to build installer
        if: ${{ matrix.installer }}
        run: |
          uv pip install pyinstaller

      - name: Build sasview with pyinstaller
        if: ${{ matrix.installer }}
        run: |
          cd installers
          rm -rf build/ dist/
          mkdir -p dist
          pyinstaller sasview.spec
          cd dist
          # the following builds a symlink farm in the package; it should
          # not be necessary, but without it, there will be lots of errors
          # about .so not found under linux.
          command -v ldconfig >/dev/null 2>&1 && ldconfig -n sasview
          tar zcf sasview-pyinstaller-dist.tar.gz sasview

      - name: Collect a debug tarball of the installer package
        if: ${{ matrix.installer }}
        uses: actions/upload-artifact@v4
        with:
          name: Debug-SasView-Installer-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            installers/dist/sasview-pyinstaller-dist.tar.gz
          if-no-files-found: warn

      - name: Install OS-specific installer tools (Windows)
        if: ${{ startsWith(matrix.os, 'windows') }}
        run: |
          choco install innosetup

      - name: Build sasview installer with INNO (Windows)
        if: ${{ startsWith(matrix.os, 'windows') }}
        run: |
          iscc installers/installer.iss
          mv installers/Output/setupSasView.exe installers/dist

      - name: Build sasview installer dmg file (OSX)
        if: ${{ startsWith(matrix.os, 'macos') }}
        run: |
          cd installers/dist
          hdiutil create $MACOS_DMG_NAME -srcfolder SasView6.app -ov -format UDZO

      - name: Build sasview installer tarball (Linux)
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        run: |
          cd installers/dist
          tar zcf SasView6.tar.gz sasview

      - name: Sign executable and create dmg (OSX)
        if: ${{ startsWith(matrix.os, 'macos') && env.SIGN_INSTALLER }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE_ISA }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_ISA_PWD }}
        run: |
          echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p DloaAcYP build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p DloaAcYP build.keychain
          security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k DloaAcYP build.keychain
          security find-identity -p codesigning

          cd installers/dist
          python ../../build_tools/fix_qt_folder_names_for_codesign.py SasView6.app
          python  ../../build_tools/code_sign_osx.py
          codesign --verify --options=runtime --entitlements ../../build_tools/entitlements.plist --timestamp --deep --verbose=4 --force --sign "Developer ID Application: The International Scattering Alliance (8CX8K63BQM)" SasView6.app
          hdiutil create $MACOS_DMG_NAME -srcfolder SasView6.app -ov -format UDZO
          codesign -s "Developer ID Application: The International Scattering Alliance (8CX8K63BQM)" $MACOS_DMG_NAME

      - name: Notarize Release Build (OSX)
        if: ${{ matrix.os == 'macos-latest' && env.SIGN_INSTALLER }}
        uses: lando/notarize-action@v2
        with:
          product-path: installers/dist/SasView6-macos-latest.dmg
          primary-bundle-id: "org.sasview.SasView6"
          appstore-connect-username: ${{ secrets.NOTARIZATION_USERNAME }}
          appstore-connect-password: ${{ secrets.NOTARIZATION_PASSWORD }}
          appstore-connect-team-id: 8CX8K63BQM
          verbose: True

      - name: Staple Release Build (OSX)
        if: ${{ matrix.os == 'macos-latest' && env.SIGN_INSTALLER }}
        uses: BoundfoxStudios/action-xcode-staple@v1
        with:
          product-path: installers/dist/SasView6-macos-latest.dmg

      - name: Install DigiCert Client tools from Github Custom Actions marketplace
        if: ${{ startsWith(matrix.os, 'windows') && env.SIGN_INSTALLER }}
        uses: digicert/ssm-code-signing@v1.1.1

      - name: Set up P12 certificate
        if: ${{ startsWith(matrix.os, 'windows') && env.SIGN_INSTALLER }}
        run: |
          echo "${{ secrets.WINDOZE_CERT_DATA }}" | base64 --decode > /d/Certificate_pkcs12.p12
        shell: bash

      - name: Set keylocker variables
        if: ${{ startsWith(matrix.os, 'windows') && env.SIGN_INSTALLER }}
        id: variables
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "SM_HOST=${{ secrets.KEYLOCKER_HOST }}" >> "$GITHUB_ENV"
          echo "SM_API_KEY=${{ secrets.KEYLOCKER_API_KEY }}" >> "$GITHUB_ENV"
          echo "SM_CLIENT_CERT_FILE=D:\\Certificate_pkcs12.p12" >> "$GITHUB_ENV"
          echo "SM_CLIENT_CERT_PASSWORD=${{ secrets.WINDOZE_CERT_PASSWORD }}" >> "$GITHUB_ENV"
        shell: bash

      - name: Sign the binary using keypair alias
        if: ${{ startsWith(matrix.os, 'windows') && env.SIGN_INSTALLER && env.RELEASE_BRANCH_BUILD }}
        run: |
           smctl sign --keypair-alias key_911959544 --input installers/dist/setupSasView.exe
        shell: cmd

      - name: Publish installer package
        uses: actions/upload-artifact@v4
        with:
          name: SasView-Installer-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            installers/dist/setupSasView.exe
            installers/dist/SasView6-macos-latest.dmg
            installers/dist/SasView6.tar.gz
          if-no-files-found: ignore


  test-installer:
    needs: [ matrix, installer-matrix ]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.installer-matrix-json) }}

    name: Test installer

    runs-on: ${{ matrix.os }}

    steps:
      - name: Set variables (Windows)
        if: ${{ startsWith(matrix.os, 'windows') }}
        run: |
          echo "INSTALL_PATH=$PWD/sasview/" >> $GITHUB_ENV
          echo "RUN_SASVIEW=$PWD/sasview/sasview.exe" >> $GITHUB_ENV

      - name: Set variables (Linux)
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        run: |
          echo "INSTALL_PATH=$PWD/sasview/" >> $GITHUB_ENV
          echo "RUN_SASVIEW=$PWD/sasview/sasview" >> $GITHUB_ENV

      - name: Set variables (Windows Powershell)
        if: ${{ startsWith(matrix.os, 'windows') }}
        shell: powershell
        # unfortunately we end up tripping over ourselves with paths
        # later on and need a PS version of the install path
        run: |
          "INSTALL_WIN_PATH=$(Get-Location)/sasview/" >> $env:GITHUB_ENV

      ### Obtain the installer, either from the previous step
      ### or from a previous run of the workflow

      - name: Retrieve installer (workflow image)
        if: ${{ env.INSTALLER_USE_OLD_IMAGE != 'true' }}
        uses: actions/download-artifact@v5
        id: download
        with:
          name: SasView-Installer-${{ matrix.os }}-${{ matrix.python-version }}

      - name: Set variables for download (workflow image)
        if: ${{ env.INSTALLER_USE_OLD_IMAGE != 'true' }}
        run: |
          echo "DL_PATH=${{steps.download.outputs.download-path}}" >> $GITHUB_ENV

      - name: Set variables for download (workflow image) (Windows)
        if: ${{ env.INSTALLER_USE_OLD_IMAGE != 'true' && startsWith(matrix.os, 'windows') }}
        shell: powershell
        run: |
          "DL_WIN_PATH=${{steps.download.outputs.download-path}}" >> $env:GITHUB_ENV

      - name: Retrieve installer (old image)
        if: ${{ env.INSTALLER_USE_OLD_IMAGE == 'true' }}
        id: download-old-installer
        uses: dawidd6/action-download-artifact@v11
        with:
          # Select a specific installer image based on the GitHub Actions run id
          run_id: ${{ env.INSTALLER_OLD_RUNID }}
          name: SasView-Installer-${{ matrix.os }}-${{ matrix.python-version }}
          path: downloads
          if_no_artifact_found: fail

      - name: Set variables for download (old image)
        if: ${{ env.INSTALLER_USE_OLD_IMAGE == 'true' }}
        run: |
          echo "DL_PATH=$PWD/downloads" >> $GITHUB_ENV

      - name: Set variables for download (old image) (Windows)
        if: ${{ env.INSTALLER_USE_OLD_IMAGE == 'true' && startsWith(matrix.os, 'windows') }}
        shell: powershell
        run: |
          "DL_WIN_PATH=$(Get-Location)/downloads" >> $env:GITHUB_ENV

      - name: Check downloads
        run: |
          echo "Sasview downloaded to: $DL_PATH"
          find "$DL_PATH"

      ### Run the installer and check that the installation looks OK

      - name: Run installer (Windows)
        if: ${{ startsWith(matrix.os, 'windows') }}
        # The installer spawns a new process and exits immediately, meaning
        # that the shell thinks it has finishes, tries to exit to move onto
        # the next step in the job, and kills the child process that is
        # trying to do the installation.
        # Wrapping the installer in "Start-Process ... -Wait" means that
        # this step doesn't exit until the installer has finished.
        shell: powershell
        run: |
          Start-Process -FilePath "${{ env.DL_WIN_PATH }}/setupSasView.exe" -ArgumentList "/SP- /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /ALLUSERS /SKIPLICENSE=true /LANG=english /NOICONS /TASKS='' /LOG=${{ env.DL_WIN_PATH }}/install.log /DIR=${{ env.INSTALL_WIN_PATH }}" -Wait

      - name: Check installation log (Windows)
        if: ${{ startsWith(matrix.os, 'windows') }}
        run: |
          echo "Contents of installation log '$DL_PATH/install.log':"
          cat $DL_PATH/install.log

      - name: Run installer (Linux)
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        run: |
          # $INSTALL_PATH is already the base directory
          tar xf "$DL_PATH/SasView6.tar.gz"

      - name: Check installation files
        if: ${{ !startsWith(matrix.os, 'macos') }}
        run: |
          echo "File listing of SasView installed in '$INSTALL_PATH'"
          find "$INSTALL_PATH"

      - name: Try running the installation (Windows)
        if: ${{ startsWith(matrix.os, 'windows') }}
        # If sasview has crashed on its own, then this should return an error
        run: |
          $RUN_SASVIEW &
          sleep 60s
          kill %1

      - name: Install X11 libraries (Linux)
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo eatmydata apt-get update
          sudo eatmydata apt-get -y install --no-install-recommends libegl1 libopengl0 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 x11-utils xvfb libxcb-cursor0

      - name: Try running the installation (Linux)
        if: ${{ startsWith(matrix.os, 'ubuntu' )}}
        # If sasview has crashed on its own, then this should return an error
        run: |
          (
            export https_proxy=https://127.0.0.1:9
            echo "## START SASVIEW"
            xvfb-run -a --server-args="-screen 0 1024x768x24" $RUN_SASVIEW 2>&1 |
            tee sasview-test.log
          ) &
          svpid=$!
          (
            set -e
            sleep 20s
            echo "## PULSE CHECK"
            kill -0 $svpid
            echo "## PULSE OK"
            sleep 40s
            echo "## FINISHING SMOKE TEST"
            kill $svpid
            echo "## SMOKE TEST COMPLETE"
            exit 0
          ) &
          pulsepid=$1
          wait $pulsepid
          # Check the log file for successful startup
          grep "SasView session started" sasview-test.log

      - name: Try running the installation (macOS)
        if: ${{ startsWith(matrix.os, 'macOS' )}}
        run: |
          hdiutil attach $DL_PATH/SasView6-${{ matrix.os }}.dmg
          # Testing scripting interface by running simple model generation through sasmodels compare
          /Volumes/SasView6/SasView6.app/Contents/MacOS/sasview -m sasmodels.compare cylinder -noplot

      ### Optionally attempt to work with the debug tarball from pyinstaller

      - name: Retrieve installer debug tarball
        if: ${{ env.INSTALLER_USE_DEBUG == 'true' }}
        id: download-old-debug
        uses: dawidd6/action-download-artifact@v11
        with:
          # Select a specific installer image based on the GitHub Actions run id
          run_id: ${{ env.INSTALLER_OLD_RUNID }}
          name: Debug-SasView-Installer-${{ matrix.os }}-${{ matrix.python-version }}
          path: downloads
          if_no_artifact_found: fail

      - name: Extract debug tarball
        if: ${{ env.INSTALLER_USE_DEBUG == 'true' }}
        run: |
          mkdir unpack
          cd unpack
          tar zxf ../downloads/sasview-pyinstaller-dist.tar.gz

      - name: Check debug installation files
        if: ${{ env.INSTALLER_USE_DEBUG == 'true' && startsWith(matrix.os, 'windows') }}
        run: |
          echo "File listing of SasView install bundle unpacked in 'unpack'"
          find unpack

      - name: Try running debug unpack
        if: ${{ env.INSTALLER_USE_DEBUG == 'true' && startsWith(matrix.os, 'windows') }}
        run: |
          cd unpack/sasview
          ./sasview.exe
